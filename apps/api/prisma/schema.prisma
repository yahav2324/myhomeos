generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum BoxState {
  OK
  LOW
  EMPTY
}

enum Unit {
  g
  ml
}


enum OtpPurpose {
  LOGIN
}

enum OtpChannel {
  SMS
  WHATSAPP
}

enum OtpStatus {
  PENDING
  VERIFIED
  EXPIRED
  LOCKED
}

enum HouseholdRole {
  OWNER
  ADMIN
  MEMBER
}

enum MemberStatus {
  ACTIVE
  INVITED
  REMOVED
}

model Box {
  id            String          @id @db.Uuid
  code          String          @unique
  deviceId      String          @unique

  name          String
  unit          Unit
  capacity      Float?

  fullQuantity  Float?
  quantity      Float           @default(0)
  percent       Float           @default(0)
  state         BoxState        @default(EMPTY)

  lastReadingAt DateTime?

  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  telemetry     TelemetryEvent[]

householdId String
household   Household @relation(fields: [householdId], references: [id], onDelete: Cascade)
}

model TelemetryEvent {
  id        String   @id @default(uuid()) @db.Uuid

  boxId     String   @db.Uuid
  box       Box      @relation(fields: [boxId], references: [id], onDelete: Cascade)

  quantity  Float
  percent   Float
  state     BoxState
  timestamp DateTime

  createdAt DateTime @default(now())

  @@index([boxId, timestamp])
}

model User {
  id                String   @id @default(uuid())
  phoneE164          String   @unique
  displayName        String?
  avatarUrl          String?
  activeHouseholdId  String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  lastLoginAt        DateTime?

  sessions           AuthSession[]
  memberships        HouseholdMember[]

  @@index([activeHouseholdId])
}

model OtpChallenge {
  id        String     @id @default(uuid())
  phoneE164 String
  purpose   OtpPurpose
  channel   OtpChannel
  codeHash  String
  expiresAt DateTime
  attempts  Int        @default(0)
  sentCount Int        @default(1)
  status    OtpStatus  @default(PENDING)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  @@index([phoneE164, status, createdAt])
}

model AuthSession {
  id               String   @id @default(uuid())
  userId           String
  refreshTokenHash String
  deviceName       String?
  createdAt        DateTime @default(now())
  lastUsedAt       DateTime @default(now())
  revokedAt        DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, revokedAt])
}

model Household {
  id        String   @id @default(uuid())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  boxes Box[]
  members HouseholdMember[]
}

model HouseholdMember {
  id          String       @id @default(uuid())
  householdId String
  userId      String
  role        HouseholdRole @default(MEMBER)
  status      MemberStatus  @default(ACTIVE)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  household Household @relation(fields: [householdId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([householdId, userId])
  @@index([userId])
}


model SystemConfig {
  id              String   @id @default(uuid())
  key             String   @unique  // לדוגמה "catalog"
  json            Json
  updatedAt       DateTime @updatedAt
  createdAt       DateTime @default(now())
}

enum TermStatus {
  PENDING
  APPROVED
  REJECTED
}

enum TermScope {
  GLOBAL
  PRIVATE
}

enum VoteValue {
  UP
  DOWN
}

model Term {
  id              String     @id @default(uuid())
  scope           TermScope  @default(GLOBAL)
  ownerUserId     String?    // אם PRIVATE
  status          TermStatus @default(PENDING)
  approvedByAdmin Boolean    @default(false)
  approvedAt      DateTime?

  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  translations    TermTranslation[]
  votes           TermVote[]

  @@index([status])
  @@index([scope, ownerUserId])
}

model TermTranslation {
  id         String   @id @default(uuid())
  termId     String
  lang       String   // "he" | "en" ...
  text       String
  normalized String   // lower/trim
  source     String   // "USER" | "AUTO" | "ADMIN"

  createdAt  DateTime @default(now())

  term       Term     @relation(fields: [termId], references: [id], onDelete: Cascade)

  @@unique([termId, lang])
  @@index([lang, normalized])
}

model TermVote {
  id        String    @id @default(uuid())
  termId    String
  userId    String
  vote      VoteValue
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  term      Term      @relation(fields: [termId], references: [id], onDelete: Cascade)

  @@unique([termId, userId])
  @@index([termId])
  @@index([userId])
}
